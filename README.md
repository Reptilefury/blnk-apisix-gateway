# APISIX Gateway - Standalone Configuration with HTTPS

APISIX API Gateway running in standalone mode with file-based YAML configuration and HTTPS support. This setup allows for easy route management and version control via Git.

## Architecture

- **APISIX**: Apache API Gateway v3.7.0
- **Mode**: Standalone (file-based configuration)
- **Configuration**: YAML-based routes in `apisix/apisix.yaml`
- **HTTPS**: Self-signed certificates with HTTP/2 support
- **Dashboard**: APISIX Dashboard for visual management (HTTP only)
- **Deployment**: Docker Compose with automatic certificate generation

## Deployment

### Prerequisites
- Docker and Docker Compose installed
- SSH access to the gateway VM

### Directory Structure

```
blnk-apisix-gateway/
├── docker-compose.yml          # Service definitions
├── apisix/
│   └── apisix.yaml             # APISIX configuration and routes
├── .gitignore                  # Git ignore rules
└── README.md                   # This file
```

## Quick Start

1. **Clone the repository**
   ```bash
   git clone https://github.com/Reptilefury/blnk-apisix-gateway.git
   cd blnk-apisix-gateway
   ```

2. **Deploy to VM**
   ```bash
   cd ~/apisix-blnk
   git pull origin main
   docker-compose down
   docker-compose up -d
   ```

3. **Verify deployment**
   ```bash
   # Check container status
   docker-compose ps

   # Test APISIX Admin API (local)
   curl -s http://127.0.0.1:9080/apisix/admin/version \
     -H "X-API-Key: edd1c9f034335f136f87ad84b625c8f1"
   ```

## Port Mappings

| Service | Internal | External | Protocol | Purpose |
|---------|----------|----------|----------|---------|
| APISIX | 9080 | 19080 | HTTP | API Gateway HTTP |
| APISIX | 9443 | 19443 | HTTPS | API Gateway HTTPS (HTTP/2) |
| Dashboard | 9000 | 19000 | HTTP | Web UI Management |
| Admin API | 9080 | - | HTTP | Admin API (internal only) |

## HTTPS Configuration

### Self-Signed Certificate
- **Status**: Enabled by default for testing/development
- **Location**: `certs/fullchain.pem` (certificate) and `certs/privkey.pem` (private key)
- **Generated by**: GitHub Actions workflow during deployment
- **Validity**: 365 days from generation
- **SNI Configured for**: `136.111.45.49` and `*.136.111.45.49`

### Accessing via HTTPS
```bash
# With self-signed certificate warning
curl -k https://136.111.45.49:19443/auth/admin/master/console/

# Or via your browser
https://136.111.45.49:19443/auth/admin/master/console/
```

### Certificate Renewal
Certificates are automatically regenerated on each deployment if missing. To regenerate:
```bash
rm certs/fullchain.pem certs/privkey.pem
docker-compose restart gateway-apisix
```

### Future: Let's Encrypt Integration
To use Let's Encrypt (requires a valid domain):
1. Update the SNI in `apisix/apisix.yaml` with your domain
2. Add certbot to the deployment script
3. Configure DNS validation for automatic renewal

See `HTTPS_SETUP.md` for detailed Let's Encrypt instructions.

## Routes

### Keycloak Authentication (`/auth/*` and `/realms/*`)
- **ID**: 20
- **Priority**: 200 (high priority to ensure it routes correctly)
- **Target**: `keycloak-438091062981.us-central1.run.app:443` (HTTPS)
- **Paths**:
  - `/auth/*` - Admin console and OAuth endpoints
  - `/realms/*` - Realm configuration and OpenID discovery
- **Features**:
  - HTTPS upstream with proper host rewriting
  - CORS enabled (all origins, with credentials support)
  - Request ID tracking for debugging
  - X-Forwarded headers properly set for HTTPS:
    - `X-Forwarded-Proto: https`
    - `X-Forwarded-Port: 19443`
    - `X-Forwarded-Host: 136.111.45.49`
    - `X-Real-IP: $remote_addr`
  - Cookie forwarding support (Set-Cookie exposed)

### Health Check Route (`/health`)
- **ID**: 1
- **Target**: `httpbin.org` (external test endpoint)
- **Purpose**: Gateway health verification

## Configuration Management

### Adding a New Route

Edit `apisix/apisix.yaml` and add to the `routes:` section:

```yaml
- id: <route-id>
  uri: "<path-pattern>"
  name: "<route-name>"
  priority: 200
  upstream:
    type: roundrobin
    nodes:
      <upstream-host>:<port>: 1
    scheme: https
  plugins:
    # Add plugins as needed
```

### Deploying Changes

```bash
# Commit and push changes
git add apisix/apisix.yaml
git commit -m "Add/update routes"
git push origin main

# Pull on gateway VM and restart
cd ~/apisix-blnk
git pull origin main
docker-compose restart gateway-apisix
```

## API Access

### Admin API (localhost)
```bash
curl http://127.0.0.1:9080/apisix/admin/routes \
  -H "X-API-Key: edd1c9f034335f136f87ad84b625c8f1"
```

### Gateway Access - Keycloak

**HTTP Access:**
```bash
# Admin Console (HTTP)
curl http://136.111.45.49:19080/auth/admin/master/console/

# OpenID Configuration (HTTP)
curl http://136.111.45.49:19080/realms/master/.well-known/openid-configuration
```

**HTTPS Access (with self-signed cert):**
```bash
# Admin Console (HTTPS - ignore cert warning)
curl -k https://136.111.45.49:19443/auth/admin/master/console/

# Or use browser
https://136.111.45.49:19443/auth/admin/master/console/

# OpenID Configuration (HTTPS)
curl -k https://136.111.45.49:19443/realms/master/.well-known/openid-configuration
```

## Troubleshooting

### View logs
```bash
# APISIX logs
docker logs gateway-apisix

# Dashboard logs
docker logs gateway-apisix-dashboard
```

### Restart services
```bash
docker-compose restart gateway-apisix
```

### Validate configuration
```bash
# Check if route is loaded
curl http://127.0.0.1:9080/apisix/admin/routes/20 \
  -H "X-API-Key: edd1c9f034335f136f87ad84b625c8f1" | jq
```

## Environment Variables

Edit `docker-compose.yml` to modify:
- `APISIX_STAND_ALONE: "true"` - Enables standalone mode
- `APISIX_API_KEY` - Admin API authentication key

## Documentation

- [APISIX Documentation](https://apisix.apache.org/docs/)
- [APISIX Standalone Mode](https://apisix.apache.org/docs/apisix/next/deployment-modes/#standalone-mode)
- [Docker Compose](https://docs.docker.com/compose/)

## License

This configuration is part of the Blnk infrastructure project.
# Trigger deployment
