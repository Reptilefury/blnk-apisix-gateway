#
# APISIX Standalone Configuration with HTTPS Support
#
deployment:
  role: traditional
  role_traditional:
    config_provider: yaml

apisix:
  node_listen:
    - 9080
    - port: 9443
      enable_http2: true
  ssl:
    enable: true
    listen:
      - port: 9443
        enable_http2: true
  enable_admin: false
  enable_ipv6: false

ssl:
  - snis:
      - "136.111.45.49"
      - "*.136.111.45.49"
    cert: /usr/local/apisix/conf/certs/fullchain.pem
    key: /usr/local/apisix/conf/certs/privkey.pem

routes:
  - id: 1
    name: "Health Test"
    uris:
      - /health
      - /test/health
    priority: 100
    upstream:
      type: roundrobin
      nodes:
        "httpbin.org:80": 1
      scheme: http

  - id: 10
    name: "BLNK Wallet API"
    uris:
      - /api/v1/*
      - /ledgers*
      - /accounts*
      - /transactions*
      - /balances*
    priority: 200
    upstream:
      type: roundrobin
      nodes:
        "blnk-server-fooaa3eima-uc.a.run.app:443": 1
      scheme: https
      pass_host: rewrite
      upstream_host: "blnk-server-fooaa3eima-uc.a.run.app"
    plugins:
      cors:
        allow_origins: "*"
        allow_methods: "GET,POST,PUT,DELETE,PATCH,OPTIONS,HEAD"
        allow_headers: "Content-Type,Authorization,X-API-Key,X-Requested-With,Cookie"
        expose_headers: "X-Request-ID,Set-Cookie,Content-Length"
        allow_credentials: true
        max_age: 86400
      request-id:
        header_name: "X-Request-ID"
        include_in_response: true
      proxy-rewrite:
        headers:
          set:
            X-Forwarded-Proto: "https"
            X-Forwarded-Host: "136.111.45.49:19080"
            X-Forwarded-Port: "19080"
            Host: "blnk-server-438091062981.us-central1.run.app"

  - id: 25
    name: "Keycloak Direct URL Interceptor"
    host: "keycloak-fooaa3eima-uc.a.run.app"
    uri: /*
    priority: 400
    upstream:
      type: roundrobin
      nodes:
        "keycloak-fooaa3eima-uc.a.run.app:443": 1
      scheme: https
      pass_host: rewrite
      upstream_host: keycloak-fooaa3eima-uc.a.run.app
    plugins:
      cors:
        allow_origins: "*"
        allow_methods: "GET,POST,PUT,DELETE,PATCH,OPTIONS,HEAD"
        allow_headers: "Content-Type,Authorization,X-API-Key,X-Requested-With,Cookie"
        expose_headers: "X-Request-ID,Set-Cookie"
        allow_credentials: true
        max_age: 86400

  - id: 15
    name: "Keycloak Admin"
    uris:
      - /admin/*
      - /auth/*
      - /realms/*
      - /resources/*
    priority: 300
    upstream:
      type: roundrobin
      nodes:
        "keycloak-fooaa3eima-uc.a.run.app:443": 1
      scheme: https
      pass_host: rewrite
      upstream_host: keycloak-fooaa3eima-uc.a.run.app
    plugins:
      cors:
        allow_origins: "*"
        allow_methods: "GET,POST,PUT,DELETE,PATCH,OPTIONS,HEAD"
        allow_headers: "Content-Type,Authorization,X-API-Key,X-Requested-With,Cookie"
        expose_headers: "X-Request-ID,Set-Cookie"
        allow_credentials: true
        max_age: 86400
      proxy-rewrite:
        headers:
          set:
            X-Forwarded-Proto: "http"
            X-Forwarded-Host: "136.111.45.49:19080"
            X-Forwarded-Port: "19080"
            Host: "keycloak-fooaa3eima-uc.a.run.app"
            Access-Control-Allow-Origin: "*"
            Access-Control-Allow-Methods: "GET,POST,PUT,DELETE,PATCH,OPTIONS,HEAD"
            Access-Control-Allow-Headers: "Content-Type,Authorization,X-API-Key,X-Requested-With,Cookie"

  - id: 20
    name: "Keycloak Proxy"
    uri: /*
    priority: 100
    upstream:
      type: roundrobin
      nodes:
        "keycloak-fooaa3eima-uc.a.run.app:443": 1
      scheme: https
      pass_host: rewrite
      upstream_host: keycloak-fooaa3eima-uc.a.run.app
    plugins:
      cors:
        allow_origins: "*"
        allow_methods: "GET,POST,PUT,DELETE,PATCH,OPTIONS,HEAD"
        allow_headers: "Content-Type,Authorization,X-API-Key,X-Requested-With,Cookie"
        expose_headers: "X-Request-ID,Set-Cookie"
        allow_credentials: true
        max_age: 86400
      request-id:
        header_name: "X-Request-ID"
        include_in_response: true
      proxy-rewrite:
        headers:
          set:
            X-Forwarded-Proto: "http"
            X-Forwarded-Host: "136.111.45.49:19080"
            X-Forwarded-Port: "19080"
            Host: "keycloak-fooaa3eima-uc.a.run.app"
            Access-Control-Allow-Origin: "*"
            Access-Control-Allow-Methods: "GET,POST,PUT,DELETE,PATCH,OPTIONS,HEAD"
            Access-Control-Allow-Headers: "Content-Type,Authorization,X-API-Key,X-Requested-With,Cookie"

#END
