#
# APISIX Standalone Configuration with HTTPS Support
#
deployment:
  role: traditional
  role_traditional:
    config_provider: yaml

apisix:
  node_listen:
    - 9080
    - port: 9443
      enable_http2: true
  ssl:
    enable: true
    listen:
      - port: 9443
        enable_http2: true
    ssl_protocols: "TLSv1.2 TLSv1.3"
  enable_admin: false
  enable_ipv6: false

ssl:
  - cert: /usr/local/apisix/conf/certs/fullchain.pem
    key: /usr/local/apisix/conf/certs/privkey.pem

routes:
  - id: 1
    name: "Health Test"
    uris:
      - /health
      - /test/health
    priority: 100
    upstream:
      type: roundrobin
      nodes:
        "httpbin.org:80": 1
      scheme: http

  - id: 12
    name: "Prediction Markets API"
    uris:
      - /api/*
    priority: 400
    upstream:
      type: roundrobin
      nodes:
        "prediction-markets-438091062981.us-central1.run.app:443": 1
      scheme: https
      pass_host: rewrite
      upstream_host: "prediction-markets-438091062981.us-central1.run.app"
    plugins:
      cors:
        allow_origins: "*"
        allow_methods: "GET,POST,PUT,DELETE,PATCH,OPTIONS,HEAD"
        allow_headers: "Content-Type,Authorization,X-API-Key,X-Requested-With,Cookie,X-Keycloak-Token,X-Magic-User-ID,X-Magic-Issuer"
        expose_headers: "X-Request-ID,Set-Cookie,Content-Length"
        allow_credentials: true
        max_age: 86400
      request-id:
        header_name: "X-Request-ID"
        include_in_response: true
      magic-did-auth:
        # Magic DID token validation
      keycloak-session:
        keycloak_url: "https://keycloak-fooaa3eima-uc.a.run.app"
        keycloak_realm: "master"
        keycloak_client_id: "admin-cli"
        redis_host: "34.63.22.56"
        redis_port: 6379
      request-enrichment:
        # Add authentication headers
      proxy-rewrite:
        headers:
          set:
            X-Forwarded-Proto: "https"
            X-Forwarded-Host: "136.111.45.49:19080"
            X-Forwarded-Port: "19080"
            Host: "prediction-markets-438091062981.us-central1.run.app"

  - id: 14
    name: "Keycloak Resources"
    uris:
      - /resources/*
    priority: 350
    upstream:
      type: roundrobin
      nodes:
        "keycloak-fooaa3eima-uc.a.run.app:443": 1
      scheme: https
      pass_host: rewrite
      upstream_host: keycloak-fooaa3eima-uc.a.run.app
    plugins:
      cors:
        allow_origins: "*"
        allow_methods: "GET,POST,PUT,DELETE,PATCH,OPTIONS,HEAD"
        allow_headers: "Content-Type,Authorization,X-API-Key,X-Requested-With,Cookie"
        expose_headers: "X-Request-ID,Set-Cookie"
        allow_credentials: true
        max_age: 86400

  - id: 15
    name: "Keycloak Admin"
    uris:
      - /admin/*
      - /auth/*
      - /realms/*
      - /resources/*
    priority: 300
    upstream:
      type: roundrobin
      nodes:
        "keycloak-fooaa3eima-uc.a.run.app:443": 1
      scheme: https
      pass_host: rewrite
      upstream_host: keycloak-fooaa3eima-uc.a.run.app
    plugins:
      cors:
        allow_origins: "*"
        allow_methods: "GET,POST,PUT,DELETE,PATCH,OPTIONS,HEAD"
        allow_headers: "Content-Type,Authorization,X-API-Key,X-Requested-With,Cookie"
        expose_headers: "X-Request-ID,Set-Cookie"
        allow_credentials: true
        max_age: 86400
      proxy-rewrite:
        headers:
          set:
            X-Forwarded-Proto: "http"
            X-Forwarded-Host: "136.111.45.49:19080"
            X-Forwarded-Port: "19080"
            Host: "keycloak-fooaa3eima-uc.a.run.app"
      response-rewrite:
        body: "s/keycloak-fooaa3eima-uc.a.run.app/136.111.45.49:19080/g"
        body_base64: false

  - id: 20
    name: "Keycloak Proxy"
    uri: /*
    priority: 50
    upstream:
      type: roundrobin
      nodes:
        "keycloak-fooaa3eima-uc.a.run.app:443": 1
      scheme: https
      pass_host: rewrite
      upstream_host: keycloak-fooaa3eima-uc.a.run.app
    plugins:
      cors:
        allow_origins: "*"
        allow_methods: "GET,POST,PUT,DELETE,PATCH,OPTIONS,HEAD"
        allow_headers: "Content-Type,Authorization,X-API-Key,X-Requested-With,Cookie"
        expose_headers: "X-Request-ID,Set-Cookie"
        allow_credentials: true
        max_age: 86400
      request-id:
        header_name: "X-Request-ID"
        include_in_response: true
      proxy-rewrite:
        headers:
          set:
            X-Forwarded-Proto: "http"
            X-Forwarded-Host: "136.111.45.49:19080"
            X-Forwarded-Port: "19080"
            Host: "keycloak-fooaa3eima-uc.a.run.app"

#END
