#
# Fixed APISIX configuration
#

node:
  listen: 0.0.0.0:9080

apisix:
  enable_admin: true
  admin_api_version: v1
  allow_admin_access_domains:
    - "127.0.0.1"
    - "localhost"
    - "apisix"
  http:
    enable_ipv6: false

plugins:
  - name: proxy-rewrite
  - name: cors
  - name: request-id

upstreams: []

routes:
  - id: 1
    name: "Health Test"
    uris:
      - "/health"
    priority: 50
    upstream:
      type: roundrobin
      nodes:
        "httpbin.org:80": 1
      scheme: http

  - id: 20
    name: "Keycloak Admin Console"
    uris:
      - "/auth/*"
    priority: 200
    upstream:
      type: roundrobin
      nodes:
        "keycloak-438091062981.us-central1.run.app:443": 1
      scheme: https
    plugins:
      - name: cors
        allow_origins: "*"
        allow_methods: "GET,POST,PUT,DELETE,PATCH,OPTIONS,HEAD"
        allow_headers: "Content-Type,Authorization,X-API-Key"
        expose_headers: "X-Request-ID"
        max_age: 86400
      - name: request-id
        header_name: "X-Request-ID"
        include_resp_header: true
      - name: proxy-rewrite
        scheme: https
        host: keycloak-438091062981.us-central1.run.app
        regex_uri:
          - "^/auth/(.*)"
          - "/admin/master/console/$1"

# End of file
